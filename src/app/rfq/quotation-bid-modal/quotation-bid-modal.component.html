<section class="submit-bid-page">
  <div class="container-fluid">
    <!-- Action Bar -->
    <div class="card cstm-ui-card mb-3 py-2 px-3 d-flex justify-content-between flex-wrap">
      <div class="d-flex">
        <button class="btn btn-lg position-relative me-2" type="button" (click)="router.navigate(['rfq/rfq-list'])">
          <i class="ft-arrow-left"></i>
        </button>
        <span class="custom-vl mx-2"></span>
        <button class="btn btn-sm cstm-ui-table-btn me-2" (click)="submitBids()">
          <i class="ft-check"></i>
          <label class="ms-1 mt-1">Submit Bids</label>
        </button>
      </div>
    </div>

    <!-- RFQ Info Fields -->
    <div class="card shadow-sm mb-4">
      <div class="card-body" style="border: 0.5px solid #53bd53; padding: 1rem; border-radius: 8px;">
        <div class="row">
          <div class="col-lg-4 col-md-6 mb-3" *ngFor="let field of [
            { label: 'RFQ No.', value: rfq?.rfqNo },
            { label: 'PR No.', value: rfq?.purchaseRequestNo },
            { label: 'Status', value: rfq?.requestStatus },
            { label: 'Owner', value: rfq?.owner },
            { label: 'Date', value: rfq?.date | date:'yyyy-MM-dd' },
            { label: 'Contact', value: rfq?.contact },
            { label: 'Delivery Location', value: rfq?.deliveryLocation },
            { label: 'Start Date', value: rfq?.startDate | date:'yyyy-MM-dd' },
            { label: 'End Date', value: rfq?.endDate | date:'yyyy-MM-dd' },
            { label: 'Title', value: rfq?.title }
          ]">
            <label class="form-label small mb-1">{{ field.label }}</label>
            <input class="form-control form-control-sm" [value]="field.value" disabled>
          </div>
        </div>
      </div>
    </div>

    <!-- Quotation Items -->
    <div class="card shadow-sm">
      <div class="card-body" style="border: 0.5px solid #53bd53; padding: 1rem; border-radius: 8px;">
        <h5 class="section-title mb-3">Quotation Items</h5>

        <div *ngFor="let item of rfq?.quotationItems" class="quotation-item mb-3 p-3 rounded border">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong class="me-1">{{ item.itemName }}</strong>
              <span class="small me-1">({{ item.itemType }})</span> —
              <span class="fw-semibold me-1">{{ item.amount | currency }}</span>
            </div>
            <!-- <button class="btn btn-outline-primary btn-sm" (click)="addBid(item.id)" [disabled]="bidMap.has(item.id)">
              <i class="ft-plus me-1"></i> Add Bid
            </button> -->
            <!-- Only show Add Bid if no bids exist in backend -->
            <button *ngIf="!item.bidSubmissionDetails || item.bidSubmissionDetails.length === 0"
              class="btn btn-outline-primary btn-sm" (click)="addBid(item.id)">
              <i class="ft-plus me-1"></i> Add Bid
            </button>

            <!-- Show "Bid already submitted" if backend has bid(s) -->
            <div *ngIf="item.bidSubmissionDetails && item.bidSubmissionDetails.length > 0"
              class="text-success small fw-semibold d-flex align-items-center">
              <i class="fa fa-check-circle me-1"></i> Bid already submitted
            </div>
          </div>

          <!-- Attachments -->
          <div class="attachment-container position-relative mb-2">
            <i class="fa fa-paperclip text-secondary cursor-pointer" (click)="toggleAttachments(item.id)"></i>
            <div class="attachment-list position-absolute bg-white border rounded shadow-sm p-2"
              *ngIf="showAttachments[item.id]" style="top: 24px; left: -10px; min-width: 180px; z-index: 10;">
              <div *ngFor="let att of item.quotationItemAttachments" class="mb-1">
                <a href="javascript:void(0)" (click)="downloadAttachment(att)">
                  {{ att.fileName }}
                </a>
              </div>
            </div>
          </div>

          <!-- Bid Section -->
          <div *ngIf="bidMap.has(item.id)  && !getBid(item.id).isDeleted"
            class="bid-section mt-3 border-top pt-3 rounded">

            <!-- EDIT MODE -->
            <div *ngIf="editingBidItemId === item.id; else viewBidSection" class="row g-3">
              <div class="col-md-4">
                <label class="form-label small">Bid Amount</label>
                <input type="number" class="form-control" [(ngModel)]="getBid(item.id).biddingAmount">
              </div>
              <div class="col-md-8">
                <label class="form-label small">Comment</label>
                <textarea rows="1" class="form-control" [(ngModel)]="getBid(item.id).comment"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Attachments</label>
                <input type="file" class="form-control" multiple (change)="onFileSelected($event, getBid(item.id))">

                <!-- Attachment chips -->
                <div class="mt-2 d-flex flex-wrap gap-2">
                  <div *ngFor="let att of getBid(item.id).vendorBidAttachments; let i = index"
                    class="badge bg-light text-dark border rounded-pill px-2 py-1 d-flex align-items-center">
                    <i class="fa fa-paperclip me-1 text-secondary"></i>
                    <a href="javascript:void(0)" (click)="downloadBidAttachment(att)"
                      class="small text-dark text-decoration-none">
                      {{ att.fileName }}
                    </a>
                    <button type="button" class="btn btn-sm btn-link text-danger ms-2 p-0"
                      (click)="removeAttachment(getBid(item.id), i)">
                      <i class="fa fa-times small"></i>
                    </button>
                  </div>
                </div>
              </div>

              <div class="col-md-12 text-end">
                <button class="btn btn-outline-success btn-sm mt-2 me-2" (click)="saveBid(item.id)">
                  <i class="ft-check me-1"></i> Save
                </button>
                <button class="btn btn-outline-danger btn-sm mt-2" (click)="deleteBid(item.id)">
                  <i class="ft-trash me-1"></i> Delete Bid
                </button>
              </div>
            </div>

            <!-- VIEW MODE -->
            <ng-template #viewBidSection>
              <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                <div>
                  <strong>Bid:</strong> {{ getBid(item.id).biddingAmount | currency }} <br>
                  <small class="text-muted">Comment: {{ getBid(item.id).comment || '—' }}</small>
                  <div class="mt-1 d-flex flex-wrap gap-2">
                    <div *ngFor="let att of getBid(item.id).vendorBidAttachments"
                      class="badge bg-light text-dark border rounded-pill px-2 py-1 d-flex align-items-center">
                      <i class="fa fa-paperclip me-1 text-secondary"></i>
                      <a href="javascript:void(0)" (click)="downloadBidAttachment(att)"
                        class="small text-dark text-decoration-none">
                        {{ att.fileName }}
                      </a>
                    </div>
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-2" (click)="editBid(item.id)">
                    <i class="fa fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-outline-danger" (click)="deleteBid(item.id)">
                    <i class="fa fa-trash me-1"></i> Delete
                  </button>
                </div>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>