<section class="submit-bid-page">
  <div class="container-fluid">
    <!-- Action Bar -->

    <div class="row">
      <div class="col-6 gap-2 d-flex align-items-center">
        <button class="btn btn-outline-secondary rounded-circle" (click)="router.navigate(['rfq/rfq-list'])"
          style="position: sticky; width: 40px; height: 40px; display: flex ; align-items: center; justify-content: center;">
          <i class="fa fa-arrow-left"></i>
        </button>
        <h1 class="mb-0">Quotation Bid</h1>
      </div>
      <div class="col-6 d-flex align-items-center justify-content-end">
        <!-- <button class="btn btn-outline-primary me-2">Cancel</button> -->
        <button class="btn btn-primary" (click)="submitBids()">
            <i class="ft-check me-1"></i>
          Submit Bid</button>
        <!-- <button 
        class="btn btn-primary"
        [disabled]="isLoading"
        (click)="submitForm()">
        {{ isEditMode ? 'Update Company' : 'Add Company' }}
    </button> -->
    
      </div>
    </div>

    <!-- <div class="card cstm-ui-card mb-3 py-2 px-3 d-flex justify-content-between flex-wrap">
      <div class="d-flex">
        <button class="btn btn-lg position-relative me-2" type="button" (click)="router.navigate(['rfq/rfq-list'])">
          <i class="ft-arrow-left"></i>
        </button>
        <span class="custom-vl mx-2"></span>
        <button class="btn btn-sm cstm-ui-table-btn me-2" (click)="submitBids()">
          <i class="ft-check"></i>
          <label class="ms-1 mt-1">Submit Bids</label>
        </button>
      </div>
    </div> -->

    <!-- RFQ Info Fields -->
    <div class="card mb-4">
      <div class="card-body">
                   <div class="row">
                  <div class="col-lg-4 col-md-6 mb-3" *ngFor="let field of [
                      { label: 'RFQ No.', value: rfq?.rfqNo },
                      { label: 'PR No.', value: rfq?.purchaseRequestNo },
                      { label: 'Status', value: rfq?.requestStatus },
                      { label: 'Owner', value: rfq?.owner },
                      { label: 'Date', value: rfq?.date | date:'yyyy-MM-dd' },
                      { label: 'Contact', value: rfq?.contact },
                      { label: 'Delivery Location', value: rfq?.deliveryLocation },
                      { label: 'Start Date', value: rfq?.startDate | date:'yyyy-MM-dd' },
                      { label: 'End Date', value: rfq?.endDate | date:'yyyy-MM-dd' },
                      { label: 'Title', value: rfq?.title }
                    ]">
                    <label class="form-label small mb-1">{{ field.label }}</label>
                    <input class="form-control form-control-sm" [value]="field.value" disabled>
                  </div>
                </div>
                 <ngb-accordion class="cstm-accordion-bid" [closeOthers]="false" [activeIds]="activeIds">

                <ngb-panel id="static-1" title="Quotation Items">
                  <ng-template ngbPanelContent>
                
                    <div *ngFor="let item of rfq?.quotationItems" class="quotation-item mb-3 p-3 rounded border">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <!-- <div>
                          <strong class="me-1">{{ item.itemName }}</strong>
                          <span class="small me-1">({{ item.itemType }})</span> —
                          <span class="fw-semibold me-1">Quantity: {{ item.orderQuantity }}</span>
              <span class="fw-semibold me-1">Request Date: {{ item.reqByDate | date:'yyyy-MM-dd'}}</span>
            </div> -->
<div>
  <div>
    <strong class="me-1">{{ item.itemName }}</strong> —
    <span class="small me-1">({{ item.itemType }})</span>
  </div>

  <div>
    <span class="fw-bold me-1">Quantity:</span>
    <span class="fw-semibold me-1">{{ item.orderQuantity }}</span> —
<span class="fw-bold me-1">UoM:</span>
    <span class="fw-semibold me-1">{{ item.unitOfMeasurementCode }}</span> —
    <span class="fw-bold me-1">Request Date:</span>
    <span class="fw-semibold">{{ item.reqByDate | date:'yyyy-MM-dd' }}</span>
  </div>
            </div>


                        <!-- <button class="btn btn-outline-primary btn-sm" (click)="addBid(item.id)" [disabled]="bidMap.has(item.id)">
                              <i class="ft-plus me-1"></i> Add Bid
                            </button> -->
                        <!-- Only show Add Bid if no bids exist in backend -->
                        <button *ngIf="!item.bidSubmissionDetails || item.bidSubmissionDetails.length === 0"
                          class="btn btn-outline-primary btn-sm" (click)="addBid(item.id)">
                          <i class="ft-plus me-1"></i> Add Bid
                        </button>
                
                        <!-- Show "Bid already submitted" if backend has bid(s) -->
                        <div *ngIf="item.bidSubmissionDetails && item.bidSubmissionDetails.length > 0"
                          class="text-success small fw-semibold d-flex align-items-center">
                          <i class="fa fa-check-circle me-1"></i> Bid already submitted
                        </div>
                      </div>
                
                      <!-- Attachments -->
                      <!-- <div class="attachment-container position-relative mb-2">
                        <i class="fa fa-paperclip text-secondary cursor-pointer" (click)="toggleAttachments(item.id)"></i>
                        <div class="attachment-list position-absolute bg-white border rounded shadow-sm p-2"
                          *ngIf="showAttachments[item.id]" style="top: 24px; left: -10px; min-width: 180px; z-index: 10;">
                          <div *ngFor="let att of item.quotationItemAttachments" class="mb-1">
                            <a href="javascript:void(0)" (click)="downloadAttachment(att)">
                              {{ att.fileName }}
                            </a>
                          </div>
                        </div>
                      </div> -->
          <!-- Attachments Button -->
          <div class="mb-2">
            <button class="btn btn-outline-secondary btn-sm d-flex align-items-center"
              (click)="openAttachmentsModal(item, attachmentsModal)">

              <i class="fa fa-paperclip me-2"></i>
              View Procurement Attachments
            </button>
          </div>
                
                      <!-- Bid Section -->
                      <div *ngIf="bidMap.has(item.id)  && !getBid(item.id).isDeleted" class="bid-section mt-3 border-top pt-3 rounded">
                
                        <!-- EDIT MODE -->
                        <div *ngIf="editingBidItemId === item.id; else viewBidSection" class="row g-3">
                          <div class="col-md-4">
                            <label class="form-label small">Bid Amount</label>
                            <input type="number" class="form-control" [(ngModel)]="getBid(item.id).biddingAmount">
                          </div>
                          <div class="col-md-8">
                            <label class="form-label small">Comment</label>
                            <textarea rows="1" class="form-control" [(ngModel)]="getBid(item.id).comment"></textarea>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label small">Attachments</label>
                            <input type="file" class="form-control" multiple (change)="onFileSelected($event, getBid(item.id))">
                
                            <!-- Attachment chips -->
                            <div class="mt-2 d-flex flex-wrap gap-2">
                              <div *ngFor="let att of getBid(item.id).vendorBidAttachments; let i = index"
                                class="badge bg-light text-dark border rounded-pill px-2 py-1 d-flex align-items-center">
                                <i class="fa fa-paperclip me-1 text-secondary"></i>
                                <a href="javascript:void(0)" (click)="downloadBidAttachment(att)"
                                  class="small text-dark text-decoration-none">
                                  {{ att.fileName }}
                                </a>
                                <button type="button" class="btn btn-sm btn-link text-danger ms-2 p-0"
                                  (click)="removeAttachment(getBid(item.id), i)">
                                  <i class="fa fa-times small"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                
                          <div class="col-md-12 text-end">
                            <button class="btn btn-outline-success btn-sm mt-2 me-2" (click)="saveBid(item.id)">
                              <i class="ft-check me-1"></i> Save
                            </button>
                            <button class="btn btn-outline-danger btn-sm mt-2" (click)="deleteBid(item.id)">
                              <i class="ft-trash me-1"></i> Delete Bid
                            </button>
                          </div>
                        </div>
                
                        <!-- VIEW MODE -->
                        <ng-template #viewBidSection>
                          <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background-color: #dbdbdb;">
                            <div>
                              <strong>Bid:</strong> {{ getBid(item.id).biddingAmount | currency }} <br>
                              <small>Comment: {{ getBid(item.id).comment || '—' }}</small>
                              <div class="mt-1 d-flex flex-wrap gap-2">
                                <div *ngFor="let att of getBid(item.id).vendorBidAttachments"
                                  class="badge bg-light text-dark border rounded-pill px-2 py-1 d-flex align-items-center">
                                  <i class="fa fa-paperclip me-1 text-secondary"></i>
                                  <a href="javascript:void(0)" (click)="downloadBidAttachment(att)"
                                    class="small text-dark text-decoration-none">
                                    {{ att.fileName }}
                                  </a>
                                </div>
                              </div>
                            </div>
                            <div>
                              <button class="btn btn-sm btn-outline-primary me-2" (click)="editBid(item.id)">
                                <i class="fa fa-edit me-1"></i> Edit
                              </button>
                              <button class="btn btn-sm btn-outline-danger" (click)="deleteBid(item.id)">
                                <i class="fa fa-trash me-1"></i> Delete
                              </button>
                            </div>
                          </div>
                        </ng-template>
                      </div>
                    </div>
                  </ng-template>
                </ngb-panel>

                  <!-- <ngb-panel id="static-2" title="Comments">
                  <ng-template ngbPanelContent>

                <form [formGroup]="form" (ngSubmit)="insertComment()" class="p-2">
                  <div class="form-group">
                    <textarea id="vendorComment" class="form-control" rows="3" placeholder="Write a comment for this vendor..."
                      formControlName="comment" [readonly]="viewMode"></textarea>
                    <div class="text-danger mt-1" *ngIf="form.controls.comment.touched && form.controls.comment.invalid">
                      Comment is required.
                    </div>
                  </div>
                
                  <div class="d-flex justify-content-end mt-2">
                    <button type="submit" class="btn btn-outline-primary" [disabled]="form.invalid">
                      <i class="ft-pocket me-1"></i>
                      Insert
                    </button>
                  </div>
                </form>

                    <div class="col-12 form-group mt-2 px-2 datatable-wrapper" [class.loading]="loading">
                      <ngx-datatable class="bootstrap core-bootstrap" [sort] [rows]="dataComments" [columnMode]="'force'" [headerHeight]="50"
                        [footerHeight]="50" rowHeight="auto" [limit]="5" [scrollbarH]="true">
                    
                        <ngx-datatable-column [width]="250" name="Comments" prop="comments">
                        </ngx-datatable-column>
                    
                        <ngx-datatable-column [width]="180" name="User" prop="createdBy">
                        </ngx-datatable-column>
                        <ngx-datatable-column [width]="120" name="By">
                          <ng-template let-row="row" ngx-datatable-cell-template>
                            <span class="label-chip" [ngClass]="row.createdByType === CreatedByType.Procurement ? 'proc' : 'vendor'">{{
                              row.createdByLabel }} </span>
                          </ng-template>
                        </ngx-datatable-column>
                    
                        <ngx-datatable-column name="Date">
                          <ng-template let-row="row" ngx-datatable-cell-template>
                            {{ row.createdOn | date:'short' }}
                          </ng-template>
                        </ngx-datatable-column>
                    
                    
                    
                    
                    
                      </ngx-datatable>
                      <div *ngIf="loading" class="datatable-spinner">
                        <div class="spinner-border"></div>
                      </div>
                    </div>

                    </ng-template>
                  </ngb-panel> -->

                  <ngb-panel id="static-3" title="Comments New">
                  <ng-template ngbPanelContent>

                    <div class="col-12"> 
                  <div class="comments-thread datatable-wrapper" [class.loading]="loading">
                    <div [ngClass]="isChatBox ? 'chatbox-scroll' : 'thread-scroll'" id="threadScroll">
                      <ng-container *ngIf="dataComments && dataComments.length > 0; else noComments">
                        <ng-container *ngFor="let msg of dataComments">
                          <div class="msg" [ngClass]="msg.createdByType === CreatedByType.Vendor ? 'out' : 'in'">
                            <div class="bubble">
                              <div class="meta">
                                <span class="name">{{ msg.createdBy }}</span>
                                <!-- <span class="label-chip" 
                                    [ngClass]="msg.createdByType === CreatedByType.Procurement ? 'proc' : 'vendor'">
                                {{ msg.createdByLabel }}
                              </span> -->
                                <span class="time">{{ msg.createdOn | date:'short' }}</span>
                              </div>
                              <div class="text">{{ msg.comments }}</div>
                            </div>
                          </div>
                        </ng-container>
                      </ng-container>
                  
                      <!-- Template for no comments -->
                      <ng-template #noComments>
                        <div class="no-comments">
                          <p class="text-muted text-center">No comments from vendors or procurement at the moment. </p>
                        </div>
                      </ng-template>
                    </div>
                  
                    <div *ngIf="loading" class="datatable-spinner">
                      <div class="spinner-border"></div>
                    </div>
                  </div>
                  <form [formGroup]="form" (ngSubmit)="insertComment()" class="mt-2 d-flex align-items-center">
                    <div class="col-md-10">
                      <textarea id="vendorComment" class="form-control" rows="1" placeholder="Write a comment for this purchase request..."
                        formControlName="comment" [readonly]="viewMode"></textarea>
                      <!-- <div class="text-danger mt-1" *ngIf="form.controls.comment.touched && form.controls.comment.invalid">
                        Comment is required.
                      </div> -->
                    </div>
                  
                    <div>
                      <button type="submit" class="btn btn-primary ms-2" [disabled]="form.invalid">
                        <i class="ft-pocket me-1"></i>
                        Insert
                      </button>
                    </div>
                  </form>


                   
                    </div>  

                  </ng-template>
                  </ngb-panel>
          </ngb-accordion>
      
      </div>
    </div>

    <!-- Quotation Items -->
    <!-- <div class="card shadow-sm">
      <div class="card-body" style="border: 0.5px solid #53bd53; padding: 1rem; border-radius: 8px;">
        <h5 class="section-title mb-3">Quotation Items</h5>

    
      </div>
    </div> -->
  </div>
</section>

<!-- Attachments Modal -->
<ng-template #attachmentsModal let-modal>
  <div class="modal-header bg-light">
    <h5 class="modal-title">
      <i class="fa fa-paperclip me-2 text-white"></i>
      Procurement Attachments - {{ selectedItem?.itemName }}
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <div *ngIf="selectedItem?.quotationItemAttachments?.length; else noAttachments">
      <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between align-items-center"
          *ngFor="let att of selectedItem.quotationItemAttachments">
          <span>
            <i class="fa fa-file text-secondary me-2"></i>
            {{ att.fileName }}
          </span>
          <button class="btn btn-sm btn-outline-primary" (click)="downloadAttachment(att)">
            <i class="fa fa-download me-1"></i>
            Download
          </button>
        </li>
      </ul>
    </div>

    <ng-template #noAttachments>
      <p class="text-muted mb-0">No attachments available for this item.</p>
    </ng-template>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Close</button>
  </div>
</ng-template>